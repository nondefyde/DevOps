name: get-envs
author: Emmanuel Okafor
decription: A generic action to get app global based envs

inputs:
  configFile:
    description: 'Entry project name'
    required: true

outputs:
  environment:
    description: 'Environment'
  vm_names:
    description: 'VM names'
  api_names:
    description: 'API names'

runs:
  using: 'composite'
  steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Check file existence
      id: check_files
      uses: andstor/file-existence-action@v1
      with:
        files: ${{ env.configFile }}

    - name: Cloud Config
      id: env-config
      uses: ActionsTools/read-json-action@main
      with:
        file_path: ${{ inputs.configFile }}

    - name: VM config
      id: vm-config
      uses: ActionsTools/read-json-action@main
      with:
        file_path: ${{ inputs.configFile }}
        prop_path: "virtual-machine"

    - name: VM config
      id: api-config
      uses: ActionsTools/read-json-action@main
      with:
        file_path: ${{ inputs.configFile }}
        prop_path: "api-management"

    - name:
      id: set-apis
      shell: bash
      run: |
        data=${{ toJson(steps.api-config.outputs.apis) }}
        names=$(echo $data | jq -r 'keys[]')
        names_array=($names)
        string_array=""
        for name in "${names_array[@]}"; do
          string_array+="'$name',"
        done
        string_array=${string_array%?}
        echo "api_names=$string_array" >> "$GITHUB_ENV"

    - name:
      id: set-vm
      shell: bash
      run: |
        data=${{ toJson(steps.vm-config.outputs.vms) }}
        names=$(echo $data | jq -r 'keys[]')
        names_array=($names)
        string_array=""
        for name in "${names_array[@]}"; do
          string_array+="'$name',"
        done
        string_array=${string_array%?}
        echo "vm_names=$string_array" >> "$GITHUB_ENV"

    - name: Set Env
      id: variables
      shell: bash
      run: |
        echo "vm_names=${{ format('[{0}]', env.vm_names) }}" >> $GITHUB_OUTPUT
        echo "api_names=${{ format('[{0}]', env.api_names) }}" >> $GITHUB_OUTPUT
        echo "environment=${{ steps.env-config.outputs.environment }}" >> $GITHUB_OUTPUT